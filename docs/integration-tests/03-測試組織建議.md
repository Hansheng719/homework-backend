# æ¸¬è©¦çµ„ç¹”å»ºè­°

## ğŸ“ æ¸¬è©¦ç¨‹å¼ç¢¼çµæ§‹

### å»ºè­°çš„å¥—ä»¶çµæ§‹

```
src/test/java/com/example/demo/
â”œâ”€â”€ integration/                           # æ•´åˆæ¸¬è©¦æ ¹ç›®éŒ„
â”‚   â”œâ”€â”€ common/                            # å…±ç”¨æ¸¬è©¦åŸºç¤è¨­æ–½
â”‚   â”‚   â”œâ”€â”€ BaseIntegrationTest.java      # æ¸¬è©¦åŸºç¤é¡åˆ¥
â”‚   â”‚   â”œâ”€â”€ TestDataBuilder.java          # æ¸¬è©¦è³‡æ–™å»ºæ§‹å™¨
â”‚   â”‚   â””â”€â”€ TestHelper.java               # æ¸¬è©¦è¼”åŠ©å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ happypath/                         # Happy Path æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ HappyPathIntegrationTest.java
â”‚   â”‚
â”‚   â”œâ”€â”€ business/                          # Business Logic æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ BusinessLogicIntegrationTest.java
â”‚   â”‚
â”‚   â”œâ”€â”€ error/                             # Error Handling æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ ErrorHandlingIntegrationTest.java
â”‚   â”‚
â”‚   â”œâ”€â”€ state/                             # State Transition æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ StateTransitionIntegrationTest.java
â”‚   â”‚
â”‚   â”œâ”€â”€ integrity/                         # Data Integrity æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ DataIntegrityIntegrationTest.java
â”‚   â”‚
â”‚   â”œâ”€â”€ cache/                             # Cache Integration æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ CacheIntegrationTest.java
â”‚   â”‚
â”‚   â””â”€â”€ edge/                              # Edge Cases æ¸¬è©¦
â”‚       â””â”€â”€ EdgeCasesIntegrationTest.java
```

## ğŸ—ï¸ åŸºç¤æ¸¬è©¦é¡åˆ¥ç¯„ä¾‹çµæ§‹

### BaseIntegrationTest (åŸºç¤é¡åˆ¥)

æ¸¬è©¦åŸºç¤é¡åˆ¥æ‡‰æä¾›ï¼š
- Spring Boot æ¸¬è©¦é…ç½®
- è³‡æ–™åº«å’Œ Redis æ¸…ç†é‚è¼¯
- å¸¸ç”¨çš„æ¸¬è©¦å·¥å…·æ³¨å…¥
- å…±ç”¨çš„é©—è­‰æ–¹æ³•

åŸºæœ¬çµæ§‹ï¼š
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
public abstract class BaseIntegrationTest {

    @Autowired
    protected TestRestTemplate restTemplate;

    @Autowired
    protected UserBalanceRepository userBalanceRepository;

    @Autowired
    protected TransferRepository transferRepository;

    @Autowired
    protected BalanceChangeRepository balanceChangeRepository;

    @Autowired
    protected RedisTemplate<String, Object> redisTemplate;

    @BeforeEach
    void cleanUp() {
        // æ¸…ç©ºè³‡æ–™åº«
        balanceChangeRepository.deleteAll();
        transferRepository.deleteAll();
        userBalanceRepository.deleteAll();

        // æ¸…ç©º Redis
        Objects.requireNonNull(redisTemplate.getConnectionFactory())
            .getConnection()
            .flushDb();
    }

    // å…±ç”¨é©—è­‰æ–¹æ³•
    protected void assertDatabaseBalance(String userId, BigDecimal expectedBalance) {
        // å¯¦ä½œçœç•¥
    }

    protected void assertRedisCache(String key, String expectedValue) {
        // å¯¦ä½œçœç•¥
    }
}
```

### TestDataBuilder (æ¸¬è©¦è³‡æ–™å»ºæ§‹å™¨)

æä¾›ä¾¿åˆ©çš„æ¸¬è©¦è³‡æ–™å»ºç«‹æ–¹æ³•ï¼š

```java
public class TestDataBuilder {

    public static CreateUserRequest buildCreateUserRequest(
        String userId,
        BigDecimal initialBalance
    ) {
        // å¯¦ä½œçœç•¥
    }

    public static CreateTransferRequest buildCreateTransferRequest(
        String fromUserId,
        String toUserId,
        BigDecimal amount
    ) {
        // å¯¦ä½œçœç•¥
    }

    // å…¶ä»–å»ºæ§‹æ–¹æ³•...
}
```

## ğŸ“ æ¸¬è©¦å‘½åæ…£ä¾‹

### æ¸¬è©¦é¡åˆ¥å‘½å

```
{Category}{Test Type}
```

ç¯„ä¾‹ï¼š
- `HappyPathIntegrationTest`
- `BusinessLogicIntegrationTest`
- `ErrorHandlingIntegrationTest`

### æ¸¬è©¦æ–¹æ³•å‘½å

ä½¿ç”¨ **Given-When-Then** æ¨¡å¼ï¼š

```
{action}_{condition}_{expectedResult}
```

ç¯„ä¾‹ï¼š
```java
// å¥½çš„å‘½å
@Test
void createTransfer_SufficientBalance_BalancesUpdatedCorrectly()

@Test
void createTransfer_InsufficientBalance_ReturnsError400()

@Test
void cancelTransfer_WithinTimeWindow_StatusChangedToCancelled()

// ä¸å¥½çš„å‘½å
@Test
void test1()

@Test
void testTransfer()

@Test
void shouldWork()
```

## ğŸ¯ æ¸¬è©¦æ¡ˆä¾‹çµ„ç¹”

### æ¯å€‹æ¸¬è©¦é¡åˆ¥å°æ‡‰ä¸€å€‹æ–‡ä»¶

| æ¸¬è©¦é¡åˆ¥ | å°æ‡‰æ–‡ä»¶ | æ¸¬è©¦æ¡ˆä¾‹æ•¸ |
|---------|---------|-----------|
| `HappyPathIntegrationTest` | [01-Happy-Path.md](test-cases/01-Happy-Path.md) | 3 |
| `BusinessLogicIntegrationTest` | [02-Business-Logic.md](test-cases/02-Business-Logic.md) | 5 |
| `ErrorHandlingIntegrationTest` | [03-Error-Handling.md](test-cases/03-Error-Handling.md) | 3 |
| `StateTransitionIntegrationTest` | [04-State-Transition.md](test-cases/04-State-Transition.md) | 3 |
| `DataIntegrityIntegrationTest` | [05-Data-Integrity.md](test-cases/05-Data-Integrity.md) | 3 |
| `CacheIntegrationTest` | [06-Cache-Integration.md](test-cases/06-Cache-Integration.md) | 3 |
| `EdgeCasesIntegrationTest` | [07-Edge-Cases.md](test-cases/07-Edge-Cases.md) | 7 |

### æ¸¬è©¦æ–¹æ³•å°æ‡‰æ¸¬è©¦æ¡ˆä¾‹

æ¯å€‹æ¸¬è©¦æ–¹æ³•å°æ‡‰ä¸€å€‹æ¸¬è©¦æ¡ˆä¾‹ IDï¼š

```java
// IT-001: å®Œæ•´è½‰å¸³æµç¨‹
@Test
void completeTransferFlow_TwoUsers_BalancesUpdatedCorrectly() {
    // å¯¦ä½œ
}

// IT-002: å–æ¶ˆ PENDING è½‰å¸³
@Test
void cancelTransfer_PendingStatus_StatusChangedToCancelled() {
    // å¯¦ä½œ
}
```

## ğŸ”§ æ¸¬è©¦è¼”åŠ©å·¥å…·

### è³‡æ–™åº«é©—è­‰è¼”åŠ©

```java
// é©—è­‰ä½¿ç”¨è€…é¤˜é¡
protected void assertUserBalance(String userId, BigDecimal expected) {
    UserBalance balance = userBalanceRepository.findByUserId(userId)
        .orElseThrow();
    assertThat(balance.getBalance()).isEqualByComparingTo(expected);
}

// é©—è­‰è½‰å¸³ç‹€æ…‹
protected void assertTransferStatus(Long transferId, TransferStatus expected) {
    Transfer transfer = transferRepository.findById(transferId)
        .orElseThrow();
    assertThat(transfer.getStatus()).isEqualTo(expected);
}
```

### Redis å¿«å–é©—è­‰è¼”åŠ©

```java
// é©—è­‰å¿«å–å­˜åœ¨
protected void assertCacheExists(String key) {
    Boolean exists = redisTemplate.hasKey(key);
    assertThat(exists).isTrue();
}

// é©—è­‰å¿«å–ä¸å­˜åœ¨
protected void assertCacheNotExists(String key) {
    Boolean exists = redisTemplate.hasKey(key);
    assertThat(exists).isFalse();
}

// é©—è­‰å¿«å–å€¼
protected void assertCacheValue(String key, String expected) {
    String value = (String) redisTemplate.opsForValue().get(key);
    assertThat(value).isEqualTo(expected);
}
```

### API è«‹æ±‚è¼”åŠ©

```java
// å»ºç«‹ä½¿ç”¨è€…
protected CreateUserResponse createUser(String userId, BigDecimal balance) {
    CreateUserRequest request = new CreateUserRequest(userId, balance);
    ResponseEntity<CreateUserResponse> response = restTemplate.postForEntity(
        "/users",
        request,
        CreateUserResponse.class
    );
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CREATED);
    return response.getBody();
}

// å»ºç«‹è½‰å¸³
protected CreateTransferResponse createTransfer(
    String fromUserId,
    String toUserId,
    BigDecimal amount
) {
    CreateTransferRequest request = new CreateTransferRequest(
        fromUserId,
        toUserId,
        amount
    );
    ResponseEntity<CreateTransferResponse> response = restTemplate.postForEntity(
        "/transfers",
        request,
        CreateTransferResponse.class
    );
    return response.getBody();
}
```

## ğŸ“Š æ¸¬è©¦è³‡æ–™ç®¡ç†

### æ¸¬è©¦è³‡æ–™æº–å‚™ç­–ç•¥

1. **æœ€å°åŒ–è³‡æ–™**: åªå»ºç«‹æ¸¬è©¦æ‰€éœ€çš„æœ€å°‘è³‡æ–™
2. **ç¨ç«‹è³‡æ–™**: æ¯å€‹æ¸¬è©¦ä½¿ç”¨ç¨ç«‹çš„ userIdï¼Œé¿å…è¡çª
3. **æ¸…ç†è³‡æ–™**: æ¸¬è©¦å‰å¾Œæ¸…ç†æ‰€æœ‰è³‡æ–™
4. **å¯è®€æ€§**: ä½¿ç”¨æœ‰æ„ç¾©çš„æ¸¬è©¦è³‡æ–™å€¼

ç¯„ä¾‹ï¼š
```java
@Test
void testExample() {
    // âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨æ¸…æ™°çš„æ¸¬è©¦è³‡æ–™
    String userA = "testUser_" + UUID.randomUUID().toString().substring(0, 8);
    BigDecimal initialBalance = new BigDecimal("1000.00");

    // âŒ ä¸å¥½çš„åšæ³•ï¼šä½¿ç”¨éš¨æ©Ÿæˆ–ç„¡æ„ç¾©çš„è³‡æ–™
    String userA = "abc123";
    BigDecimal initialBalance = new BigDecimal("999.99");
}
```

### æ¸¬è©¦è³‡æ–™å¸¸æ•¸

å®šç¾©å…±ç”¨çš„æ¸¬è©¦å¸¸æ•¸ï¼š

```java
public class TestConstants {
    public static final BigDecimal INITIAL_BALANCE_1000 = new BigDecimal("1000.00");
    public static final BigDecimal INITIAL_BALANCE_500 = new BigDecimal("500.00");
    public static final BigDecimal TRANSFER_AMOUNT_300 = new BigDecimal("300.00");

    public static final String CACHE_KEY_PREFIX = "balance::";
}
```

## ğŸ¨ æ–·è¨€æœ€ä½³å¯¦è¸

### ä½¿ç”¨ AssertJ é€²è¡Œæµæš¢æ–·è¨€

```java
// âœ… æ¨è–¦ï¼šä½¿ç”¨ AssertJ
assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
assertThat(balance.getBalance()).isEqualByComparingTo(expectedBalance);
assertThat(transfers).hasSize(3);

// âŒ ä¸æ¨è–¦ï¼šä½¿ç”¨ JUnit Assert
assertEquals(HttpStatus.OK, response.getStatusCode());
assertTrue(balance.getBalance().compareTo(expectedBalance) == 0);
```

### æ–·è¨€è¨Šæ¯

```java
// âœ… å¸¶æœ‰æ¸…æ™°è¨Šæ¯çš„æ–·è¨€
assertThat(response.getStatusCode())
    .as("API should return 201 CREATED for successful user creation")
    .isEqualTo(HttpStatus.CREATED);

// âŒ æ²’æœ‰è¨Šæ¯çš„æ–·è¨€
assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CREATED);
```

### å¤šé‡é©—è­‰

```java
// âœ… ä½¿ç”¨ assertAll æˆ–å¤šå€‹æ–·è¨€
assertThat(transfer)
    .extracting("fromUserId", "toUserId", "amount", "status")
    .containsExactly("userA", "userB", new BigDecimal("300.00"), TransferStatus.COMPLETED);

// æˆ–è€…
assertThat(transfer.getFromUserId()).isEqualTo("userA");
assertThat(transfer.getToUserId()).isEqualTo("userB");
assertThat(transfer.getAmount()).isEqualByComparingTo(new BigDecimal("300.00"));
assertThat(transfer.getStatus()).isEqualTo(TransferStatus.COMPLETED);
```

## ğŸ” é—œéµæª”æ¡ˆè·¯å¾‘åƒè€ƒ

### Controller
- `src/main/java/com/example/demo/controller/UserController.java`
- `src/main/java/com/example/demo/controller/TransferController.java`

### Service
- `src/main/java/com/example/demo/service/BalanceService.java`
- `src/main/java/com/example/demo/service/TransferService.java`

### Repository
- `src/main/java/com/example/demo/repository/UserBalanceRepository.java`
- `src/main/java/com/example/demo/repository/TransferRepository.java`
- `src/main/java/com/example/demo/repository/BalanceChangeRepository.java`

### Entity
- `src/main/java/com/example/demo/entity/UserBalance.java`
- `src/main/java/com/example/demo/entity/Transfer.java`
- `src/main/java/com/example/demo/entity/BalanceChange.java`

### DTO
- `src/main/java/com/example/demo/facade/dto/CreateUserRequest.java`
- `src/main/java/com/example/demo/facade/dto/CreateTransferRequest.java`
- å…¶ä»– Request/Response DTO

## ğŸ“‹ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

å»ºç«‹æ–°æ¸¬è©¦æ™‚ï¼Œç¢ºèªï¼š
- [ ] æ¸¬è©¦é¡åˆ¥ç¹¼æ‰¿ `BaseIntegrationTest`
- [ ] æ¸¬è©¦æ–¹æ³•å‘½åéµå¾ªæ…£ä¾‹
- [ ] æ¸¬è©¦æœ‰æ¸…æ™°çš„ Given-When-Then çµæ§‹
- [ ] ä½¿ç”¨ `@BeforeEach` æ¸…ç†è³‡æ–™
- [ ] API é©—è­‰åŒ…å«ç‹€æ…‹ç¢¼å’Œå›æ‡‰å…§å®¹
- [ ] è³‡æ–™åº«é©—è­‰ä½¿ç”¨ SQL æŸ¥è©¢ç¢ºèª
- [ ] Redis é©—è­‰æª¢æŸ¥å¿«å–ç‹€æ…‹
- [ ] æ–·è¨€æœ‰æ¸…æ™°çš„è¨Šæ¯
- [ ] æ¸¬è©¦ç¨ç«‹ä¸”å¯é‡è¤‡åŸ·è¡Œ
- [ ] æ¸¬è©¦å°æ‡‰æ–‡ä»¶ä¸­çš„æ¸¬è©¦æ¡ˆä¾‹

## ğŸš€ æŒçºŒæ•´åˆå»ºè­°

### CI/CD Pipeline æ•´åˆ

```yaml
# .github/workflows/integration-tests.yml ç¯„ä¾‹
name: Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: testdb
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass
          MYSQL_ROOT_PASSWORD: rootpass
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run Integration Tests
        run: ./mvnw clean test -Dspring.profiles.active=test

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: target/surefire-reports/
```

## ğŸ”— ç›¸é—œè³‡æº

- [æ¸¬è©¦æ¡ˆä¾‹æ–‡ä»¶](test-cases/) - æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹è¦æ ¼
- [ç’°å¢ƒè¨­å®š](01-ç’°å¢ƒè¨­å®š.md) - æ¸¬è©¦ç’°å¢ƒæº–å‚™
- [åŸ·è¡ŒæŒ‡å—](02-æ¸¬è©¦åŸ·è¡ŒæŒ‡å—.md) - åŸ·è¡Œæ¸¬è©¦æ–¹æ³•

---

**æç¤º**: ä¿æŒæ¸¬è©¦ç¨‹å¼ç¢¼çš„æ•´æ½”å’Œå¯ç¶­è­·æ€§èˆ‡ç”¢å“ç¨‹å¼ç¢¼åŒç­‰é‡è¦ã€‚
