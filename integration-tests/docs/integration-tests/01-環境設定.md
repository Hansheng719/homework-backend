# æ¸¬è©¦ç’°å¢ƒè¨­å®šæŒ‡å—

## ğŸ“‹ ç’°å¢ƒéœ€æ±‚

### å¿…è¦è»Ÿé«”
- **Docker** >= 20.10
- **Docker Compose** >= 2.0
- **Maven** >= 3.8 (æˆ–ä½¿ç”¨å°ˆæ¡ˆçš„ mvnw)
- **Java** >= 17

### æ¸¬è©¦åŸºç¤è¨­æ–½
- **MySQL 8.0** - è³‡æ–™åº«
- **Redis 7** - å¿«å–å±¤

## ğŸ³ Docker Compose é…ç½®

### å»ºç«‹æ¸¬è©¦ç’°å¢ƒé…ç½®æª”

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å»ºç«‹ `docker-compose-test.yml`:

```yaml
version: '3.8'

services:
  # MySQL æ¸¬è©¦è³‡æ–™åº«
  mysql-test:
    image: mysql:8.0
    container_name: homework-mysql-test
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: testdb
      MYSQL_USER: testuser
      MYSQL_PASSWORD: testpass
    ports:
      - "3307:3306"  # ä½¿ç”¨ 3307 é¿å…èˆ‡æœ¬åœ° MySQL è¡çª
    volumes:
      - mysql-test-data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "testuser", "-ptestpass"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis æ¸¬è©¦å¿«å–
  redis-test:
    image: redis:7-alpine
    container_name: homework-redis-test
    ports:
      - "6380:6379"  # ä½¿ç”¨ 6380 é¿å…èˆ‡æœ¬åœ° Redis è¡çª
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  mysql-test-data:
```

## âš™ï¸ æ‡‰ç”¨ç¨‹å¼æ¸¬è©¦é…ç½®

### application-test.yml

åœ¨ `src/test/resources/application-test.yml` å»ºç«‹æˆ–æ›´æ–°ï¼š

```yaml
spring:
  application:
    name: homework-backend-test

  # MySQL æ¸¬è©¦è³‡æ–™åº«é…ç½®
  datasource:
    url: jdbc:mysql://localhost:3307/testdb?useSSL=false&serverTimezone=Asia/Taipei&allowPublicKeyRetrieval=true
    username: testuser
    password: testpass
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000

  # JPA é…ç½®
  jpa:
    hibernate:
      ddl-auto: create-drop  # æ¸¬è©¦ç’°å¢ƒæ¯æ¬¡é‡å»º schema
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQL8Dialect
        use_sql_comments: true

  # Redis å¿«å–é…ç½®
  data:
    redis:
      host: localhost
      port: 6380
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2

  # Spring Cache é…ç½®
  cache:
    type: redis
    redis:
      time-to-live: 300000  # 5 åˆ†é˜ TTL
      cache-null-values: false

# æ—¥èªŒé…ç½®
logging:
  level:
    root: INFO
    com.example.demo: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.springframework.cache: TRACE
    org.springframework.jdbc: DEBUG
```

## ğŸ—„ï¸ è³‡æ–™åº« Schema

æ¸¬è©¦ç’°å¢ƒä½¿ç”¨ `ddl-auto: create-drop`ï¼Œæ¯æ¬¡æ¸¬è©¦åŸ·è¡Œæ™‚è‡ªå‹•å»ºç«‹ Schemaã€‚

### ä¸»è¦è³‡æ–™è¡¨

#### 1. user_balances (ä½¿ç”¨è€…é¤˜é¡è¡¨)
```sql
CREATE TABLE user_balances (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL UNIQUE,
    balance DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    version BIGINT NOT NULL DEFAULT 0,  -- æ¨‚è§€é–ç‰ˆæœ¬è™Ÿ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);
```

#### 2. transfers (è½‰å¸³è¨˜éŒ„è¡¨)
```sql
CREATE TABLE transfers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    from_user_id VARCHAR(50) NOT NULL,
    to_user_id VARCHAR(50) NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    status VARCHAR(20) NOT NULL,  -- PENDING, COMPLETED, CANCELLED, FAILED
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    cancelled_at TIMESTAMP NULL,
    failure_reason VARCHAR(500) NULL,
    INDEX idx_from_user (from_user_id),
    INDEX idx_to_user (to_user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

#### 3. balance_changes (é¤˜é¡è®Šå‹•è¨˜éŒ„è¡¨)
```sql
CREATE TABLE balance_changes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    external_id BIGINT NOT NULL,  -- é—œè¯çš„ transfer_id
    user_id VARCHAR(50) NOT NULL,
    type VARCHAR(20) NOT NULL,  -- TRANSFER_OUT, TRANSFER_IN
    amount DECIMAL(15,2) NOT NULL,
    balance_before DECIMAL(15,2) NOT NULL,
    balance_after DECIMAL(15,2) NOT NULL,
    status VARCHAR(20) NOT NULL,  -- COMPLETED, FAILED
    failure_reason VARCHAR(500) NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_external_type (external_id, type),  -- å†ªç­‰æ€§ç´„æŸ
    INDEX idx_user_id (user_id),
    INDEX idx_external_id (external_id)
);
```

## ğŸš€ ç’°å¢ƒå•Ÿå‹•æ­¥é©Ÿ

### 1. å•Ÿå‹•æ¸¬è©¦åŸºç¤è¨­æ–½

```bash
# é€²å…¥å°ˆæ¡ˆæ ¹ç›®éŒ„
cd /path/to/homework-backend

# å•Ÿå‹•æ‰€æœ‰æ¸¬è©¦æœå‹™
docker-compose -f docker-compose-test.yml up -d

# æŸ¥çœ‹æœå‹™ç‹€æ…‹
docker-compose -f docker-compose-test.yml ps

# æŸ¥çœ‹æ—¥èªŒ (å¯é¸)
docker-compose -f docker-compose-test.yml logs -f
```

é æœŸè¼¸å‡ºï¼š
```
NAME                     IMAGE               STATUS              PORTS
homework-mysql-test      mysql:8.0           Up (healthy)        0.0.0.0:3307->3306/tcp
homework-redis-test      redis:7-alpine      Up (healthy)        0.0.0.0:6380->6379/tcp
```

### 2. é©—è­‰æœå‹™å¯ç”¨æ€§

#### é©—è­‰ MySQL
```bash
# æ–¹æ³• 1: ä½¿ç”¨ mysql å®¢æˆ¶ç«¯
mysql -h 127.0.0.1 -P 3307 -u testuser -ptestpass testdb -e "SELECT 1 AS test;"

# æ–¹æ³• 2: ä½¿ç”¨ Docker
docker exec homework-mysql-test mysql -utestuser -ptestpass testdb -e "SELECT 1 AS test;"
```

é æœŸè¼¸å‡ºï¼š
```
+------+
| test |
+------+
|    1 |
+------+
```

#### é©—è­‰ Redis
```bash
# æ–¹æ³• 1: ä½¿ç”¨ redis-cli
redis-cli -p 6380 ping

# æ–¹æ³• 2: ä½¿ç”¨ Docker
docker exec homework-redis-test redis-cli ping
```

é æœŸè¼¸å‡ºï¼š
```
PONG
```

### 3. æ¸¬è©¦ç’°å¢ƒé€£ç·š

åŸ·è¡Œç°¡å–®çš„é€£ç·šæ¸¬è©¦ï¼š

```bash
# æ¸¬è©¦ MySQL é€£ç·š
./mvnw test -Dspring.profiles.active=test -Dtest=*None

# å¦‚æœæˆåŠŸï¼Œæ‡‰è©²çœ‹åˆ° Hibernate å»ºç«‹ Schema çš„æ—¥èªŒ
```

## ğŸ§ª æ¸¬è©¦è³‡æ–™æº–å‚™

### æ‰‹å‹•æ¸¬è©¦è³‡æ–™æ’å…¥ (å¯é¸)

å¦‚éœ€æ‰‹å‹•é©—è­‰ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹ SQL:

```sql
-- å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…
INSERT INTO user_balances (user_id, balance) VALUES ('testUser1', 1000.00);
INSERT INTO user_balances (user_id, balance) VALUES ('testUser2', 500.00);

-- å»ºç«‹æ¸¬è©¦è½‰å¸³
INSERT INTO transfers (from_user_id, to_user_id, amount, status)
VALUES ('testUser1', 'testUser2', 200.00, 'COMPLETED');

-- æŸ¥è©¢é©—è­‰
SELECT * FROM user_balances;
SELECT * FROM transfers;
```

### Redis æ¸¬è©¦è³‡æ–™ (å¯é¸)

```bash
# è¨­å®šæ¸¬è©¦å¿«å–
redis-cli -p 6380 SET "balance::testUser1" "1000.00"

# æŸ¥è©¢æ¸¬è©¦å¿«å–
redis-cli -p 6380 GET "balance::testUser1"

# æ¸…ç©ºæ‰€æœ‰å¿«å–
redis-cli -p 6380 FLUSHDB
```

## ğŸ§¹ ç’°å¢ƒæ¸…ç†

### æ¸…ç†æ¸¬è©¦è³‡æ–™

æ¯å€‹æ¸¬è©¦æ¡ˆä¾‹æ‡‰åœ¨ `@BeforeEach` ä¸­æ¸…ç†è³‡æ–™ï¼š

```java
@BeforeEach
void setUp() {
    balanceChangeRepository.deleteAll();
    transferRepository.deleteAll();
    userBalanceRepository.deleteAll();
    redisTemplate.getConnectionFactory()
        .getConnection()
        .flushDb();
}
```

### åœæ­¢æ¸¬è©¦ç’°å¢ƒ

```bash
# åœæ­¢æ‰€æœ‰æœå‹™ (ä¿ç•™è³‡æ–™å·)
docker-compose -f docker-compose-test.yml stop

# åœæ­¢ä¸¦ç§»é™¤æ‰€æœ‰æœå‹™ (ä¿ç•™è³‡æ–™å·)
docker-compose -f docker-compose-test.yml down

# åœæ­¢ä¸¦ç§»é™¤æ‰€æœ‰æœå‹™å’Œè³‡æ–™å· (å®Œå…¨æ¸…ç†)
docker-compose -f docker-compose-test.yml down -v
```

### é‡æ–°å•Ÿå‹•ä¹¾æ·¨ç’°å¢ƒ

```bash
# å®Œå…¨æ¸…ç†ä¸¦é‡æ–°å•Ÿå‹•
docker-compose -f docker-compose-test.yml down -v
docker-compose -f docker-compose-test.yml up -d

# ç­‰å¾…æœå‹™å¥åº·æª¢æŸ¥é€šé
sleep 10
docker-compose -f docker-compose-test.yml ps
```

## ğŸ” å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1: MySQL é€£ç·šå¤±æ•—

**ç—‡ç‹€**: `Communications link failure`

**è§£æ±ºæ–¹æ³•**:
```bash
# æª¢æŸ¥ MySQL æ˜¯å¦æ­£åœ¨é‹è¡Œ
docker ps | grep mysql-test

# æª¢æŸ¥ MySQL æ—¥èªŒ
docker logs homework-mysql-test

# é©—è­‰ç«¯å£æ˜¯å¦è¢«ä½”ç”¨
netstat -an | grep 3307

# é‡å•Ÿ MySQL å®¹å™¨
docker-compose -f docker-compose-test.yml restart mysql-test
```

### å•é¡Œ 2: Redis é€£ç·šå¤±æ•—

**ç—‡ç‹€**: `Unable to connect to Redis`

**è§£æ±ºæ–¹æ³•**:
```bash
# æª¢æŸ¥ Redis æ˜¯å¦æ­£åœ¨é‹è¡Œ
docker ps | grep redis-test

# æª¢æŸ¥ Redis æ—¥èªŒ
docker logs homework-redis-test

# æ¸¬è©¦é€£ç·š
redis-cli -p 6380 ping

# é‡å•Ÿ Redis å®¹å™¨
docker-compose -f docker-compose-test.yml restart redis-test
```

### å•é¡Œ 3: Schema æœªè‡ªå‹•å»ºç«‹

**ç—‡ç‹€**: `Table 'testdb.user_balances' doesn't exist`

**è§£æ±ºæ–¹æ³•**:
```bash
# ç¢ºèª application-test.yml ä¸­ ddl-auto è¨­å®š
# spring.jpa.hibernate.ddl-auto: create-drop

# æª¢æŸ¥æ—¥èªŒæ˜¯å¦æœ‰ Hibernate å»ºè¡¨èªå¥
./mvnw test -X -Dspring.profiles.active=test

# æ‰‹å‹•å»ºè¡¨ (å¦‚æœéœ€è¦)
mysql -h 127.0.0.1 -P 3307 -u testuser -ptestpass testdb < schema.sql
```

### å•é¡Œ 4: ç«¯å£è¡çª

**ç—‡ç‹€**: `port is already allocated`

**è§£æ±ºæ–¹æ³•**:
```bash
# æŸ¥çœ‹ç«¯å£ä½”ç”¨
lsof -i :3307
lsof -i :6380

# ä¿®æ”¹ docker-compose-test.yml ä½¿ç”¨ä¸åŒç«¯å£
# ä¾‹å¦‚: "3308:3306" å’Œ "6381:6379"

# åŒæ™‚æ›´æ–° application-test.yml ä¸­çš„ç«¯å£é…ç½®
```

## ğŸ“Š ç’°å¢ƒé©—è­‰æª¢æŸ¥æ¸…å–®

åŸ·è¡Œæ¸¬è©¦å‰ï¼Œç¢ºèªä»¥ä¸‹é …ç›®ï¼š

- [ ] Docker æœå‹™æ­£å¸¸é‹è¡Œ
- [ ] MySQL å®¹å™¨ç‹€æ…‹ç‚º healthy
- [ ] Redis å®¹å™¨ç‹€æ…‹ç‚º healthy
- [ ] MySQL ç«¯å£ 3307 å¯é€£ç·š
- [ ] Redis ç«¯å£ 6380 å¯é€£ç·š
- [ ] application-test.yml é…ç½®æ­£ç¢º
- [ ] Maven/Java ç’°å¢ƒæ­£å¸¸

é©—è­‰å‘½ä»¤ï¼š
```bash
# ä¸€éµé©—è­‰è…³æœ¬
./verify-test-env.sh
```

å»ºç«‹ `verify-test-env.sh`:
```bash
#!/bin/bash

echo "ğŸ” é©—è­‰æ¸¬è©¦ç’°å¢ƒ..."

# æª¢æŸ¥ Docker
if ! docker ps > /dev/null 2>&1; then
    echo "âŒ Docker æœªé‹è¡Œ"
    exit 1
fi
echo "âœ… Docker æ­£å¸¸é‹è¡Œ"

# æª¢æŸ¥ MySQL
if ! docker exec homework-mysql-test mysql -utestuser -ptestpass -e "SELECT 1" > /dev/null 2>&1; then
    echo "âŒ MySQL é€£ç·šå¤±æ•—"
    exit 1
fi
echo "âœ… MySQL é€£ç·šæ­£å¸¸"

# æª¢æŸ¥ Redis
if ! docker exec homework-redis-test redis-cli ping > /dev/null 2>&1; then
    echo "âŒ Redis é€£ç·šå¤±æ•—"
    exit 1
fi
echo "âœ… Redis é€£ç·šæ­£å¸¸"

echo "ğŸ‰ æ¸¬è©¦ç’°å¢ƒé©—è­‰é€šéï¼"
```

## ğŸ”— ä¸‹ä¸€æ­¥

ç’°å¢ƒè¨­å®šå®Œæˆå¾Œï¼Œè«‹åƒè€ƒï¼š
- [æ¸¬è©¦åŸ·è¡ŒæŒ‡å—](02-æ¸¬è©¦åŸ·è¡ŒæŒ‡å—.md) - äº†è§£å¦‚ä½•åŸ·è¡Œæ¸¬è©¦
- [Happy Path æ¸¬è©¦æ¡ˆä¾‹](test-cases/01-Happy-Path.md) - é–‹å§‹ç¬¬ä¸€å€‹æ¸¬è©¦æ¡ˆä¾‹

---

**æç¤º**: å»ºè­°å°‡ `docker-compose-test.yml` åŠ å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œä½†å°‡æ¸¬è©¦å¯†ç¢¼ç­‰æ•æ„Ÿè³‡è¨Šå­˜æ”¾åœ¨ç’°å¢ƒè®Šæ•¸æˆ– `.env` æª”æ¡ˆä¸­ï¼ˆä¸¦åŠ å…¥ `.gitignore`ï¼‰ã€‚
