# 測試執行指南

## 📋 前置準備

在執行測試前，請確認：
1. ✅ 已完成 [環境設定](01-環境設定.md)
2. ✅ Docker 容器正常運行 (MySQL, Redis)
3. ✅ 測試配置檔 `application-test.yml` 已設定

## 🚀 執行整合測試

### 執行所有整合測試

```bash
# 使用 Maven Wrapper (推薦)
./mvnw clean test -Dspring.profiles.active=test

# 或使用系統 Maven
mvn clean test -Dspring.profiles.active=test
```

### 執行特定測試類別

```bash
# 執行 Happy Path 測試
./mvnw test -Dspring.profiles.active=test -Dtest=HappyPathIntegrationTest

# 執行 Business Logic 測試
./mvnw test -Dspring.profiles.active=test -Dtest=BusinessLogicIntegrationTest

# 執行 Error Handling 測試
./mvnw test -Dspring.profiles.active=test -Dtest=ErrorHandlingIntegrationTest

# 執行 State Transition 測試
./mvnw test -Dspring.profiles.active=test -Dtest=StateTransitionIntegrationTest

# 執行 Data Integrity 測試
./mvnw test -Dspring.profiles.active=test -Dtest=DataIntegrityIntegrationTest

# 執行 Cache Integration 測試
./mvnw test -Dspring.profiles.active=test -Dtest=CacheIntegrationTest

# 執行 Edge Cases 測試
./mvnw test -Dspring.profiles.active=test -Dtest=EdgeCasesIntegrationTest
```

### 執行特定測試方法

```bash
# 執行單一測試方法
./mvnw test -Dspring.profiles.active=test \
  -Dtest=HappyPathIntegrationTest#completeTransferFlow_TwoUsers_BalancesUpdatedCorrectly

# 使用萬用字元執行多個測試
./mvnw test -Dspring.profiles.active=test -Dtest=*IntegrationTest
```

### 跳過單元測試，只執行整合測試

```bash
# 執行所有整合測試，跳過單元測試
./mvnw test -Dspring.profiles.active=test -Dtest=**/*IntegrationTest
```

## 📊 查看測試報告

### Surefire 測試報告

```bash
# 執行測試後查看報告
open target/surefire-reports/index.html

# Linux
xdg-open target/surefire-reports/index.html

# Windows
start target/surefire-reports/index.html
```

### 終端機輸出

測試執行時會顯示：
- ✅ 通過的測試
- ❌ 失敗的測試
- ⏭️ 跳過的測試
- 📊 測試統計

範例輸出：
```
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running com.example.demo.integration.HappyPathIntegrationTest
[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 5.234 s
[INFO]
[INFO] Results:
[INFO]
[INFO] Tests run: 27, Failures: 0, Errors: 0, Skipped: 0
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
```

## 🔍 測試執行流程

### 標準測試流程

每個測試案例遵循以下流程：

```
1. @BeforeEach
   ├─ 清空資料庫所有資料表
   ├─ 清空 Redis 所有快取
   └─ 準備測試所需的前置資料

2. 執行測試
   ├─ 發送 API 請求
   ├─ 驗證 API 回應
   ├─ 查詢資料庫驗證狀態
   └─ 查詢 Redis 驗證快取

3. @AfterEach (可選)
   └─ 額外清理工作
```

### 測試隔離

每個測試方法都是獨立的：
- ✅ 資料庫在每個測試前清空
- ✅ Redis 在每個測試前清空
- ✅ 測試之間互不影響
- ✅ 可以任意順序執行

## 🐛 除錯測試

### 啟用詳細日誌

```bash
# 啟用 SQL 日誌
./mvnw test -Dspring.profiles.active=test -Dlogging.level.org.hibernate.SQL=DEBUG

# 啟用 Cache 日誌
./mvnw test -Dspring.profiles.active=test -Dlogging.level.org.springframework.cache=TRACE

# 啟用所有 DEBUG 日誌
./mvnw test -Dspring.profiles.active=test -Dlogging.level.com.example.demo=DEBUG
```

### 暫停測試進行手動驗證

在測試程式碼中加入斷點或睡眠：

```java
@Test
void testExample() {
    // 執行 API 請求
    var response = restTemplate.postForEntity(...);

    // 暫停以便手動檢查資料庫
    Thread.sleep(60000); // 暫停 60 秒

    // 繼續驗證
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
}
```

在暫停期間，可以手動查詢資料庫或 Redis：

```bash
# 查詢資料庫
mysql -h 127.0.0.1 -P 3307 -u testuser -ptestpass testdb

mysql> SELECT * FROM user_balances;
mysql> SELECT * FROM transfers;

# 查詢 Redis
redis-cli -p 6380
127.0.0.1:6380> KEYS *
127.0.0.1:6380> GET balance::userA
```

### 單步執行測試

使用 IDE 除錯功能：

**IntelliJ IDEA**:
1. 在測試方法旁點擊綠色箭頭
2. 選擇 "Debug 'testMethodName'"
3. 設定斷點進行單步執行

**VS Code**:
1. 安裝 Java Test Runner 擴充功能
2. 點擊測試方法旁的除錯圖示
3. 設定斷點進行單步執行

## 📈 測試覆蓋率

### 產生覆蓋率報告 (使用 JaCoCo)

```bash
# 執行測試並產生覆蓋率報告
./mvnw clean test jacoco:report

# 查看報告
open target/site/jacoco/index.html
```

### 覆蓋率目標

| 層級 | 目標覆蓋率 |
|------|-----------|
| 整合測試 | >= 80% |
| Controller | >= 90% |
| Service | >= 85% |
| Repository | >= 75% |

## ⚡ 效能優化

### 平行執行測試

在 `pom.xml` 中配置 Surefire:

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <configuration>
        <parallel>classes</parallel>
        <threadCount>4</threadCount>
    </configuration>
</plugin>
```

執行：
```bash
./mvnw test -Dspring.profiles.active=test
```

### 重用測試容器 (Testcontainers)

如果使用 Testcontainers，可啟用重用模式：

```properties
# src/test/resources/.testcontainers.properties
testcontainers.reuse.enable=true
```

## 🔧 常見問題排查

### 問題 1: 測試執行失敗 - 連線資料庫失敗

**錯誤訊息**:
```
Communications link failure
```

**解決方法**:
```bash
# 確認 MySQL 容器運行中
docker ps | grep mysql-test

# 確認端口正確
netstat -an | grep 3307

# 重啟容器
docker-compose -f docker-compose-test.yml restart mysql-test
```

### 問題 2: 測試執行失敗 - Redis 連線失敗

**錯誤訊息**:
```
Unable to connect to Redis
```

**解決方法**:
```bash
# 確認 Redis 容器運行中
docker ps | grep redis-test

# 測試 Redis 連線
redis-cli -p 6380 ping

# 重啟容器
docker-compose -f docker-compose-test.yml restart redis-test
```

### 問題 3: 測試資料未清理

**症狀**: 測試失敗，顯示資料已存在

**解決方法**:
```java
// 確認 @BeforeEach 中有清理邏輯
@BeforeEach
void setUp() {
    balanceChangeRepository.deleteAll();
    transferRepository.deleteAll();
    userBalanceRepository.deleteAll();

    // 清空 Redis
    Objects.requireNonNull(redisTemplate.getConnectionFactory())
        .getConnection()
        .flushDb();
}
```

### 問題 4: 快取未失效

**症狀**: 測試預期快取已清除，但仍然存在

**解決方法**:
```bash
# 手動檢查 Redis
redis-cli -p 6380 KEYS '*'

# 手動清空 Redis
redis-cli -p 6380 FLUSHDB

# 檢查程式碼中的快取失效邏輯
```

### 問題 5: 測試執行緩慢

**可能原因**:
- Docker 容器資源不足
- 大量資料插入
- 未使用連線池

**解決方法**:
```bash
# 增加 Docker 資源配額
# Docker Desktop -> Settings -> Resources

# 優化測試資料量
# 只建立必要的測試資料

# 檢查連線池配置
# application-test.yml 中的 hikari 設定
```

## 📝 測試執行檢查清單

執行測試前：
- [ ] Docker 容器正常運行
- [ ] MySQL 健康檢查通過
- [ ] Redis 健康檢查通過
- [ ] application-test.yml 配置正確
- [ ] 測試資料準備完成

執行測試中：
- [ ] 觀察測試輸出日誌
- [ ] 注意錯誤訊息
- [ ] 記錄失敗的測試案例

執行測試後：
- [ ] 檢視測試報告
- [ ] 分析失敗原因
- [ ] 驗證覆蓋率達標
- [ ] 清理測試環境 (可選)

## 🔗 相關連結

- [環境設定](01-環境設定.md) - 設定測試環境
- [測試案例](test-cases/) - 各類別測試案例
- [測試組織建議](03-測試組織建議.md) - 測試程式碼組織

## 💡 最佳實踐

1. **測試前先驗證環境**: 使用 `verify-test-env.sh` 確認環境正常
2. **測試隔離**: 確保每個測試獨立運行，不相互依賴
3. **清晰的斷言**: 使用有意義的斷言訊息
4. **適當的等待**: 對於非同步操作，使用合理的等待時間
5. **日誌記錄**: 保留測試執行日誌以便問題追蹤

---

**提示**: 建議在 CI/CD 流程中自動執行整合測試，確保每次程式碼變更都經過完整驗證。
